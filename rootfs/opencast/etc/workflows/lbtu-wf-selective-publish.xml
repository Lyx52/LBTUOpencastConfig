<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definition xmlns="http://workflow.opencastproject.org">
  <id>lbtu-wf-selective-publish</id>
  <title>LBTU Selective Publishing Workflow</title>
  <description>Workflow that publishes presenter video to current event and room-composite to duplicate</description>
  <operations>
	
	<operation
		id="tag"
		description="Retag media to source for archiving">
		<configurations>
			<configuration key="source-flavors">*/combined</configuration>
			<configuration key="target-tags">+archive</configuration>
			<configuration key="target-flavor">*/source</configuration>
		</configurations>
	</operation>

	<operation
		id="analyze-tracks"
		exception-handler-workflow="partial-error"
		description="Analyze combined source videos">
		<configurations>
			<configuration key="source-flavor">*/source</configuration>
		</configurations>
    </operation>

	<!-- If we have presenter media and room-composite media, we need to seperate them into two events -->
	<operation
		id="duplicate-event"
		if="(${room-composite_source_media} AND ${presenter_source_media})"
		description="Duplicate room-composite to seperate event">
		<configurations>
			<configuration key="source-flavors">*/*</configuration>
			<configuration key="number-of-events">1</configuration>
			<configuration key="max-number-of-events">1</configuration>
			<configuration key="no-suffix">true</configuration>
			<configuration key="set-title">#{episode.title} (Conference room recording)</configuration>
			<configuration key="property-namespaces">org.opencastproject.assetmanager.security,org.opencastproject.workflow.configuration</configuration>
		</configurations>
	</operation>
	
	<operation 
		id="start-workflow"
		if="(${room-composite_source_media} AND ${presenter_source_media})"
		description="Start publishing room-composite to seperate event">
	  <configurations>
		<configuration key="workflow-definition">lbtu-wf-publish</configuration>
		<configuration key="media-packages">${duplicate_media_package_ids}</configuration>
		<configuration key="source-type">room-composite</configuration>
	  </configurations>
	</operation>
	
	<!-- Conditionally set source-type based on existence of types of video -->
	
	<operation 
		id="conditional-config" 
	    description="Set source-type depending on ">
		<configurations>
			<configuration key="configuration-name">source-type</configuration>
			
			<!-- If room-composite and presenter video exists -->
			<configuration key="condition-1">
				(${room-composite_source_media} AND ${presenter_source_media})
			</configuration>
			<configuration key="value-1">presenter</configuration>
			
			<!-- If only room-composite video exists -->
			<configuration key="condition-2">
				${room-composite_source_media}
			</configuration>
			<configuration key="value-2">room-composite</configuration>
			
			<!-- If only presenter video exists -->
			<configuration key="condition-3">
				${presenter_source_media}
			</configuration>
			<configuration key="value-3">presenter</configuration>
			
			<!-- Assume room-composite -->
			<configuration key="no-match">room-composite</configuration>
		</configurations>
	</operation>
	
	<!--  Publish engage based on source-type -->
	
	<operation
      id="include"
      description="Publish source-type to engage">
      <configurations>
        <configuration key="workflow-id">lbtu-wf-publish</configuration>
      </configurations>
    </operation>
  </operations>
</definition>
