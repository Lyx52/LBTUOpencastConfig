<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<definition xmlns="http://workflow.opencastproject.org">
  <id>lbtu-wf-publish</id>
  <title>Publish combined videos</title>
  <description>Workflow that publishes combined video to engage</description>
  <operations>

    <!-- Prepare media for processing -->
    <operation
      id="clone"
      fail-on-error="true"
      exception-handler-workflow="partial-error"
      description="Clone media to prepared">
      <configurations>
        <configuration key="source-flavor">${source-type}/source</configuration>
        <configuration key="target-flavor">${source-type}/prepared</configuration>
      </configurations>
    </operation>

    <operation
      id="select-tracks"
      exception-handler-workflow="partial-error"
      description="Selecting audio/video streams for processing">
      <configurations>
        <configuration key="source-flavor">${source-type}/prepared</configuration>
        <configuration key="target-flavor">${source-type}/work</configuration>
        <configuration key="target-tags">-archive</configuration>
        <configuration key="audio-muxing">duplicate</configuration>
      </configurations>
    </operation>

    <operation
      id="analyze-tracks"
      exception-handler-workflow="partial-error"
      description="Analyzing tracks in media package and setting control variables">
      <configurations>
        <configuration key="source-flavor">${source-type}/work</configuration>
      </configurations>
    </operation>


    <!-- Cut the video according the SMIL file -->
    <operation
      id="clone"
      exception-handler-workflow="partial-error"
      description="Creating working copy of the cutting information">
      <configurations>
        <configuration key="source-flavor">smil/cutting</configuration>
        <configuration key="target-flavor">smil/tmp</configuration>
      </configurations>
    </operation>

    <operation
      id="editor"
      exception-handler-workflow="partial-error"
      description="Cutting the recording according to the edit decision list">
      <configurations>
        <configuration key="source-flavors">${source-type}/work</configuration>
        <configuration key="smil-flavors">smil/tmp</configuration>
        <configuration key="target-smil-flavor">smil/tmp</configuration>
        <configuration key="target-flavor-subtype">trimmed</configuration>
        <configuration key="interactive">false</configuration>
      </configurations>
    </operation>

    <!-- Encode to engage search result thumbnails -->

    <operation
      id="image"
      exception-handler-workflow="partial-error"
      description="Creating search result default thumbnails">
      <configurations>
        <configuration key="source-flavor">${source-type}/trimmed</configuration>
        <configuration key="target-flavor">${source-type}/search+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">search-cover.http</configuration>
        <configuration key="time">3</configuration>
      </configurations>
    </operation>

        <!-- Encode to engage player preview images -->

    <operation
      id="image"
      exception-handler-workflow="partial-error"
      description="Creating player preview image for video">
      <configurations>
        <configuration key="source-flavor">${source-type}/trimmed</configuration>
        <configuration key="target-flavor">${source-type}/player+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-preview.http</configuration>
        <configuration key="time">3</configuration>
      </configurations>
    </operation>

    <!-- Encode to feed cover images -->

    <operation
      id="image"
      exception-handler-workflow="partial-error"
      description="Creating feed cover image">
      <configurations>
        <configuration key="source-flavor">${source-type}/trimmed</configuration>
        <configuration key="target-flavor">${source-type}/feed+preview</configuration>
        <configuration key="target-tags">atom,rss</configuration>
        <configuration key="encoding-profile">feed-cover.http</configuration>
        <configuration key="time">3</configuration>
      </configurations>
    </operation>


    <!-- Create a cover image with the default template -->

    <operation
      id="cover-image"
      fail-on-error="true"
      exception-handler-workflow="partial-error"
      description="Create a cover image">
      <configurations>
        <configuration key="stylesheet">file://${karaf.etc}/branding/coverimage.xsl</configuration>
        <configuration key="width">1920</configuration>
        <configuration key="height">1080</configuration>
        <configuration key="posterimage-flavor">${source-type}/coverbackground</configuration>
        <configuration key="target-flavor">${source-type}/player+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
     </configurations>
    </operation>

    <!-- Generate timeline preview images -->

    <operation
      id="timelinepreviews"
      fail-on-error="false"
      exception-handler-workflow="partial-error"
      description="Creating timeline preview images">
      <configurations>
        <configuration key="source-flavor">${source-type}/trimmed</configuration>
        <configuration key="target-flavor">${source-type}/timeline+preview</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="image-count">100</configuration>
      </configurations>
    </operation>

    <!--  Theme video -->
    
    <operation
      id="include"
      description="Including theming operations">
      <configurations>
        <configuration key="workflow-id">lbtu-wf-partial-theming</configuration>
      </configurations>
    </operation>


    <!-- Encode to Engage player format -->

    <operation
      id="encode"
      exception-handler-workflow="partial-error"
      description="Encoding videos to mp4 delivery format">
      <configurations>
        <configuration key="source-flavor">${source-type}/themed</configuration>
        <configuration key="target-flavor">${source-type}/delivery</configuration>
        <configuration key="target-tags">engage-download,engage-streaming</configuration>
        <configuration key="encoding-profile">adaptive-parallel.http</configuration>
      </configurations>
    </operation>

    <!-- Run the videosegmentation -->

    <operation
      id="segment-video"
      fail-on-error="false"
      description="Segmenting video">
      <configurations>
        <configuration key="source-flavor">${source-type}/themed</configuration>
        <configuration key="target-tags">engage-download</configuration>
      </configurations>
    </operation>

    <!-- Generate segment preview images -->

    <operation
      id="segmentpreviews"
      fail-on-error="false"
      description="Creating preview images for video segments">
      <configurations>
        <configuration key="source-flavor">${source-type}/themed</configuration>
        <configuration key="target-flavor">${source-type}/segment+preview</configuration>
        <configuration key="reference-flavor">${source-type}/delivery</configuration>
        <configuration key="reference-tags">engage-download</configuration>
        <configuration key="target-tags">engage-download</configuration>
        <configuration key="encoding-profile">player-slides.http</configuration>
      </configurations>
    </operation>

    <!-- Extract text form slide preview images -->

    <operation
      id="extract-text"
      fail-on-error="false"
      description="Extracting text from video segments">
      <configurations>
        <configuration key="source-flavor">${source-type}/themed</configuration>
        <configuration key="target-tags">engage-download</configuration>
      </configurations>
    </operation>

    <!-- Publish to engage player -->

    <operation
      id="publish-engage"
      max-attempts="2"
      exception-handler-workflow="partial-error"
      description="Publishing to Opencast Media Module">
      <configurations>
        <configuration key="download-source-flavors">dublincore/*,security/*,captions/*</configuration>
        <configuration key="download-source-tags">engage-download,atom,rss</configuration>
        <configuration key="streaming-source-tags">engage-streaming</configuration>
        <configuration key="check-availability">true</configuration>
      </configurations>
    </operation>

   <!-- Archive the recording -->

    <operation
      id="snapshot"
      if="${straightToPublishing}"
      description="Archive publishing information">
      <configurations>
        <configuration key="source-flavors">captions/*</configuration>
        <configuration key="source-tags">archive</configuration>
      </configurations>
    </operation>

    <!-- Clean up work artifacts -->

    <operation
      id="cleanup"
      fail-on-error="false"
      description="Remove temporary processing artifacts">
      <configurations>
        <!-- On systems with shared workspace or working file repository -->
        <!-- you want to set this option to false. -->
        <configuration key="delete-external">true</configuration>
        <!-- ACLs are required again when working through ActiveMQ messages -->
        <configuration key="preserve-flavors">security/*</configuration>
      </configurations>
    </operation>

  </operations>
</definition>
